# pipeline

Reusable (Composite) Github Actions for Bizzy CI/CD pipelines

File name should be action.yml or action.yaml

For details see [this info](https://docs.github.com/en/actions/creating-actions/creating-a-composite-action)

## Goal

The purpose of this action is to standardize the Bizzy CI/CD pipelines avoiding code duplication and enforcing these features:

* Include a branch protection rule to only allow merging of code to main via Pull Requests.
* Force the approval of each Pull Request by at least one user in the CODEOWNERS file.
* Automated update of CHANGELOG file based on the body of the Pull Request.
* Automatically create a Release with the next semver version based on Pull Requests tags.
* Scans reporitory to check if there are credentials stored as plain text.

## Repo Visibility

This repository is *public*. However, it doesn't contain any credentials or sensitive info.

If we set the repository to private, we'll need to checkout this repo on each client repo before using it. Also, the [post-run command will fail](https://stackoverflow.com/questions/69034292/how-do-you-use-a-composite-action-that-exists-in-a-private-repository)

It's possible to set repositories as [Internal](https://dev.to/n3wt0n/finally-custom-github-actions-in-internal-repos-4l91) but this option is only available for Enterprise GitHub accounts.

## Client Repo Configuration

Visit the labels page of the repo (https://github.com/organization/repo-name/labels)

Add the following 3 labels to the repo that will run this action:

```
Name: release-major
Description: Increases 9.x.x version
Color: red #E0022F
```

```
Name: release-minor
Description: Increases x.9.x version
Color: yellow #E6E826
```

```
Name: release-patch
Description: Increases x.x.9 version
Color: green #33E224
```

These labels can be used to tag a Pull Request before merging it into main branch so we can choose how to increase the semantic version

## PERSONAL_ACCESS_TOKEN repo

This action requires passing a variable named inputs.github-token

That token is the value of the organizational secret PERSONAL_ACCESS_TOKEN, provided by each client pipeline using this composite action.

That secret was generated by creating a Personal Access Token for the `bizzy-robot` GitHub user. These are the scopes required:

- repo (so it's able to clone any repos like argocd repos)
- write:packages (so it can create a new GitHub release or even push a docker image to the GitHub registry)

Please set Expiration to Never.

NOTE: For details see [this documentation](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)

## Production pipeline

On the repo where the pipeline should be executed create a file named (for example) `.github/workflows/ci-prod.yaml`

```
name: ci-prod

# Runs when a PR is closed on main branch
on:
  pull_request:
    branches:
      - main  
    types:
      - closed

jobs:
  build:
    # PR should also be merged (not only closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      # Bizzy CI/CD Action 
      - name: Run CI/CD composite action
        uses: bizzyteam/pipeline@main
        with:
          # Application and environment
          app-name: "application-name"
          for-prod: true

          # Docker registry, repo and credentials
          docker-registry: "ghcr.io"
          docker-repository: "organization/your-repo"
          docker-username: ${{ github.actor }}
          docker-password: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

          # ArgoCD repo and values file
          argocd-repo: "organization/argo-repo"
          argocd-values-file: "path/to/prod-values.yaml"
          argocd-repo-ssh-key: ${{ secrets.REPO_ARGO_PROD_SSHKEY }}

          # GitHub account to write commits
          github-robot-user: github-robot
          github-robot-email: github-email
          github-robot-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
```

## Staging pipeline

On the repo where the pipeline should be executed create a file named (for example) `.github/workflows/ci-test.yaml`

```
name: ci-test

# Runs when a commit is pushed to develop
on:
  push:
    branches:
      - develop 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Bizzy CI/CD Action 
      - name: Run CI/CD composite action
        uses: bizzyteam/pipeline@main
        with:
          # Application and environment
          app-name: "application-name"
          for-prod: false

          # Docker registry, repo and credentials
          docker-registry: "ghcr.io"
          docker-repository: "organization/your-repo"
          docker-username: ${{ github.actor }}
          docker-password: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

          # ArgoCD repo and values file
          argocd-repo: "organization/argo-repo"
          argocd-values-file: "path/to/test-values.yaml"
          argocd-repo-ssh-key: ${{ secrets.REPO_ARGO_TEST_SSHKEY }}

          # GitHub account to write commits
          github-robot-user: github-robot
          github-robot-email: github-email
          github-robot-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
```
